<?xml version="1.0"?>
<!-- build command: ant build -->
<project name="Generic" default="." basedir=".">
    <description>Generic Firefox add-on build script</description>

    <property name="src" location="."/>
    <property name="build" location="build"/>
    <property name="dist" location="xpi"/>

    <!-- determine version number based on install.rdf -->
    <target name="read-install.rdf">
        <xmlproperty file="${src}/install.rdf"/>
    </target>

    <target name="copy-build" depends="read-install.rdf">
        <mkdir dir="${build}"/>

        <copy todir="${build}">
            <fileset dir="${src}">
                <exclude name=".git/**"/>
                <exclude name="xpi/**"/>
                <exclude name="build/**"/>
                <exclude name=".gitignore"/>
                <exclude name="build.xml"/>
                <exclude name="README.md"/>
            </fileset>
        </copy>
    </target>

    <target name="clean-build" depends="copy-build">
        <echo>Stripping log() invocations</echo>
        <replaceregexp byline="true">
            <regexp pattern="\s+log\(.+\);"/>
            <substitution expression=""/>
            <fileset dir="${build}">
                <include name="**/*.js"/>
            </fileset>
        </replaceregexp>
    </target>

    <!-- archive sources into .xpi file -->
    <target name="archive" depends="copy-build" description="archive the add-on">
        <mkdir dir="${dist}"/>

        <delete file="${dist}/${RDF.Description.em:name}-${RDF.Description.em:version}.xpi" quiet="true"/>

        <zip destfile="${dist}/${RDF.Description.em:name}-${RDF.Description.em:version}.xpi" level="9">
            <fileset dir="${build}"/>
        </zip>
    </target>

    <!-- post-build cleanup -->
    <target name="cleanup">
        <delete dir="${build}"/>
    </target>

<!-- build without stripping log() invocations -->
    <target name="build-debug" depends="archive, cleanup">
    </target>

<!-- main build action -->
    <target name="build" depends="clean-build, archive, cleanup">
    </target>

</project>